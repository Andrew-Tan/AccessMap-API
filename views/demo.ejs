<% include header.ejs %>

<script type="text/javascript">
  document.write("\<script src='//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js' type='text/javascript'>\<\/script>");
</script>

<form class="pure-form pure-form-stacked">
  <fieldset>
    <!-- Upper box with Title, username, and password -->
    <div class="upper-box">
      <!-- Title -->
      <div>
        <h1 class="title-padding">API Demo</h1>
      </div>
      <div class="pure-control-group">
        <!-- Username label and input -->
        <label class="labels">Access Token:</label>

        <div class="input-fields">
          <textarea id="acctoken" title="" cols="75" rows="10"><%= access_token %></textarea>
        </div>
      </div>
      <div class="pure-control-group">
        <!-- Password label and input -->
        <label class="labels">Refresh Token:</label>

        <div class="input-fields">
          <textarea id="reftoken" title="" cols="75" rows="10"><%= refresh_token %></textarea>
        </div>
      </div>
      <div class="pure-control-group">
        <label class="labels">New Profile:</label>

        <div class="input-fields">
          <textarea title="send" id="logJson" cols="75" rows="9"></textarea>
        </div>
      </div>
    </div>
    <!-- Bottom box with Sign in -->
    <div class="bottom-box">
      <div class="pure-controls sign-in-button">
        <button id="addNew" type="button" class="pure-button pure-button-primary">Add Profile</button>
      </div>
      <br>
      <div class="pure-controls sign-in-button">
        <button id="getAll" type="button" class="pure-button pure-button-primary">Get Profiles</button>
      </div>
    </div>
    <div class="bottom-box">
      <div class="input-fields">
        <textarea title="response" id="responseJson" cols="75" rows="15" >[No response received yet]</textarea>
      </div>
    </div>
  </fieldset>
  <div class="from-text">
    <a href="https://github.com/FrankHassanabad/Oauth2orizeRecipes">
      From OAuth2OrizeRecipes
    </a>
  </div>
</form>

<script>
  const randNum00 = Math.random();
  const randNum01 = Math.random();
  const randNum02 = Math.random();
  const randNum1 = Math.floor(Math.random() * 10000);
  const randNum2 = Math.floor(Math.random() * 10000);
  const json = {
    "profileName": "testProfile - " + randNum1,
    "inclineMin": randNum00 + randNum01,
    "inclineMax": randNum00 + randNum02,
    "inclineIdeal": randNum01 + randNum02,
    "avoidCurbs": randNum1 % 2 === 0,
    "avoidConstruction": randNum2 % 2 === 0
  };

  $("#logJson").val(JSON.stringify(json, null, 2));
</script>

<script>
  const errorHandler = function (jqXHR, exception) {
    let msg;
    if (jqXHR.status === 0) {
      msg = 'No response, might be network failure or server rejection';
    } else if (jqXHR.status == 404) {
      msg = 'Requested page not found. [404]';
    } else if (jqXHR.status == 500) {
      msg = 'Internal Server Error [500].';
    } else if (exception === 'parsererror') {
      msg = 'Requested JSON parse failed.';
    } else if (exception === 'timeout') {
      msg = 'Time out error.';
    } else if (exception === 'abort') {
      msg = 'Ajax request aborted.';
    } else {
      msg = 'Uncaught Error.\n' + jqXHR.responseText;
    }
    $("#responseJson").val('[ ' + msg + ' ]');
  };

  const successHandler = function (result) {
      $("#responseJson").val(JSON.stringify(result, null, 2));
  };

  $(document).ready(function () {
    $("#addNew").click(function () {
      try {
        const parsedJson = JSON.parse($("#logJson").val());
        $.ajax({
          type: 'PUT',
          headers: {
            "Authorization": "Bearer " + $("#acctoken").val()
          },
          url: "/api/profile",
          data: parsedJson,
          success: successHandler,
          error: errorHandler,
        });
      } catch (error) {
        $("#responseJson").val(error.toString());
      }
    });

    $("#getAll").click(function () {
      $.ajax({
        type: 'GET',
        headers: {
          "Authorization": "Bearer " + $("#acctoken").val()
        },
        url: "/api/profiles",
        success: successHandler,
        error: errorHandler,
      });
    });
  });
</script>

<<% include footer.ejs %>